package com.ekinoksyazilim.etkk.prototype.comm;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.InetSocketAddress;
import java.net.Socket;
import java.net.SocketAddress;
import java.util.concurrent.ConcurrentLinkedQueue;
import java.util.concurrent.ConcurrentSkipListSet;

public class EndPoint <T> {

	private ConcurrentLinkedQueue<Envelope<T>> inbox = new ConcurrentLinkedQueue<>();
	private ConcurrentLinkedQueue<Envelope<T>> outbox = new ConcurrentLinkedQueue<>();
	
	private ConcurrentSkipListSet<IEndPointListener<T>> listeners = new ConcurrentSkipListSet<>();
	
	private Socket socket;
	
	private IPackageExtractor extractor;
	
	private IParser<T> parser;
	
	public EndPoint(Socket socket, IPackageExtractor extractor, IParser<T> parser) {
		
		this.socket = socket;
		this.extractor = extractor;
		this.parser = parser;
	}
	
	public void send(T message, InetSocketAddress to) {

		outbox.add(new Envelope<T>(message, to));
	}

	public void receive(T message, InetSocketAddress from) {
		
		inbox.add(new Envelope<T>(message, from));
	}
	
	public void addListener(IEndPointListener<T> listener) {

		listeners.add(listener);
	}

	public void removeListener(IEndPointListener<T> listener) {

		listeners.remove(listener);
	}
	

	boolean read() {
		try {

			InputStream inputStream = socket.getInputStream();
			
			byte[] data = extractor.extract(inputStream);

			if (data != null) {

				Object message = endPoint.getParser().decode(data);

				receive(message, (InetSocketAddress) endPoint.getSocket().getRemoteSocketAddress());

				somethingHappened = true;
			}

		} catch (IOException e) {

			e.printStackTrace();
		}
	}
	
	boolean write() {
		
		try {

			OutputStream outputStream = endPoint.getSocket().getOutputStream();
			
			Envelope<?> envelope = endPoint.pollOutbox();

			if (envelope != null) {

				byte[] data = endPoint.getParser().encode(envelope.getMessage());

				outputStream.write(data);
				outputStream.flush();
			}
			
		} catch (IOException e) {
			
			e.printStackTrace();
		}
	}
	
	boolean dispatch() {
	
		Envelope<?> envelope = endPoint.pollInbox();
		Object message = envelope.getMessage();
	}
}
